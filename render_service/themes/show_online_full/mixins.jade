include config

- months = ["января", "февраля", "марта", "апреля", "мая", "июня", "июля", "августа", "сентября", "октября", "ноября", "декабря"];
- date_now = new Date();

- function format_stat_number(i) {
-   if( i < 1000 ) {
-       return '<s>' + i + '</s>';
-   } else {
-       big = Math.floor(i/1000);
-       small = i - big*1000 || '000';
-       return '<b>' + big + '</b>' + '<s>' + small + '</s>';
-   }
- }
- function colon_duration_text(sec_total) {
-   var ho, mi, res, da;
-   ho = Math.floor(sec_total / 3600);
-   min = Math.floor( (sec_total - ho*3600) / 60 );
-   sec = sec_total - ho*3600 - min*60;
-   if (min < 10) min = '0' + min;
-   if (sec < 10) sec = '0' + sec;
-   return (ho ? (ho+':') : '') + min + ':' + sec;
- }
- function cardinal(val, form1, form2, form3) {
-   var d10;
-   if (val > 4 && val < 21) return form3;
-   d10 = val % 10;
-   if (d10 == 0 || d10 > 4) return form3;
-   if (d10 == 1) return form1;
-   return form2;
- }
- function duration_text(min) {
-   var ho, mi, res, da;
-   ho = Math.floor(min / 60); mi = min - ho*60;
-   da = Math.floor(ho / 24); ho = ho % 24;
-   res = da?da + cardinal(da, " день", " дня", " дней"):"";
-   res+= (res?" ":"") + (ho?ho + cardinal(ho, " час", " часа", " часов"):"");
-   if (mi) res+= (res?" ":"") + mi + cardinal(mi, " минута", " минуты", " минут");
-   return res || "0 минут";
- }
- function date_text(dt) {
-   return dt.getDate() + " " + months[dt.getMonth()] + " " + dt.getFullYear() + " г.";
- }
- function date_text_str(str) {
-   try {
-       return date_text(new Date(str));
-   } catch (e) {
-       return str;
-   }
- }
- function cardinal(val, form1, form2, form3) {
-   var d10;
-   if (val > 4 && val < 21) return form3;
-   d10 = val % 10;
-   if (d10 == 0 || d10 > 4) return form3;
-   if (d10 == 1) return form1;
-   return form2;
- }
- function utime_text_str(str) {
-   try {
-       return time_text(new Date(str * 1000));
-   } catch (e) {
-       return str;
-   }
- }
- function time_text(dt) {
-   var diff, curday, curtime, ho, text, min, input_day, now_day, at_time, tz_offset;
-   diff = (date_now.getTime() - dt.getTime()) / 1000;
-   if (Math.abs(diff) < 60) return "сейчас";
-   if (Math.abs(diff) < 3600) {
-     min = Math.floor( Math.abs(diff) / 60);
-     text = min + cardinal(min, " минуту", " минуты", " минут");
-     if (diff < 0) {
-       return "через " + text;
-     } else {
-       return text + " назад";
-     }
-   }
-   ho = Math.floor( Math.abs(diff) / 3600);
-   if (ho <= 6) {
-     text = ho + cardinal(ho, " час", " часа", " часов");
-     if( diff < 0 ) {
-       return "через " + text;
-     } else {
-       return text + " назад";
-     }
-   }
-   tz_offset = date_now.getTimezoneOffset() * 60 * 1000;
-   input_day = Math.floor( (dt.getTime() - tz_offset)  / 86400000 );
-   now_day = Math.floor( (date_now.getTime() - tz_offset) / 86400000 );
-   at_time = dt.getHours() + ":" + ( dt.getMinutes() < 10 ? "0"  : "" ) + dt.getMinutes();
-   if ( now_day == input_day ) {
-     return "сегодня в " + at_time;
-   } else if ( now_day == input_day+1 )  {
-     return "вчера в " + at_time;
-   }
-   if (dt.getFullYear() == date_now.getFullYear()) return dt.getDate() + " " + months[dt.getMonth()];
-   return dt.getDate() + " " + months[dt.getMonth()] + " " + dt.getFullYear();
- }


mixin cast_thumb(item)
    - topic = ""
    - href = "#"
    if item.units && item.units[0]
        - topic = item.units[0].topic.title
        - href = "/" + item.units[0].topic.name + "/video/" + item.id
        if item.units[0].morder
            - film_name = item.units[0].title + ", " + item.units[0].morder + " серия"
        else
            - film_name = item.units[0].title
    else
        - href = "/video/" + item.id
        - film_name = item.title
    if topic
        - film_name = topic + ": " + film_name

    a(href=href, title="", data-mi-athref="id")
        .lheight0.fsize0
            .rel.cast-poster-wrapper
                -url=res.global.content_media + item.id + "/poster"
                img(src=url, alt=film_name, title=film_name, data-mi-atsrc="id", data-mi-atalt="title", data-mi-attitle="title").cast-poster
                .cast-play-btn.zmin
                    .play-triangle
            .rel.zmin
                .cast-duration(data-mi-name="duration")=colon_duration_text(item.duration)
    .cast-thumb-def
        div.film-name
            a(href=href, title="", data-mi-name="title", data-mi-athref="id")=film_name
        i.sprite.sprite-i-icon-clock
        span(data-mi-name="date")=utime_text_str(item.releasedate)

mixin user_thumb_rating(item, index, is_star)
        - is_first_class = ''
        if index == 0
            - is_first_class = 'is-first'
        li.person-rating-item(class=is_first_class)
            .thumb-wrapper
                .rating-index
                    if is_first_class
                        if is_star
                            .sprite.sprite-i-person-rating-star
                        else
                            .sprite.sprite-i-person-rating-cup
                    else
                        =(index + 1) + " "
                            i &mdash;
                - tmp_url = res.global.content_users + item.id + "/avatar"
                img(src=tmp_url, alt="", title="").person-img
            .person-def
                - user_url = '/users/' + item.id
                a(href=user_url).person-name=item.name
                span.sprite.sprite-i-rating
                if item.rating
                    span.rating-text="Рейтинг: "
                        i=item.rating
                if item.topic
                    .cast-name="Сериал: "
                        i=item.topic.title
                    .star-role="Роль: "
                        i=item.topic.role

mixin news_thumb(news_item)
    if news_item.img_url && news_item.img_url.length > 0
        img(src=news_item.img_url, alt=news_item.cast_name, title=news_item.cast_name).cast-news-img
    .cast-news-def
        .cast-news-header
            if news_item.topic
                - url = "/"+news_item.topic.name
                a.cast-name(href=url)=news_item.topic.title
            span.cast-date= ' / ' + utime_text_str(news_item.date)
        .cast-news-title
        //- if( news_item.comments_count != null ) {
        //    .cast-news-comments-count
        //        span.sprite.sprite-i-speech-bubble
        //        em=news_item.comments_count
        //- }
            - url = "/news/" + news_item.id
            if news_item.topic
                - url = "/" + news_item.topic.name + url
            a(href=url)=news_item.title
    .clearboth

mixin casts_list(casts)
    if casts && casts.length
        .casts-list-inner
            .tab-btn-group
                .fright
                    a(href="#").tab-btn.tab-btn-active.nav-btn-back
                        .solid-arrow-left

                    a(href="#").tab-btn.tab-btn-active.nav-btn-forward
                        .solid-arrow-right
                a(href="#").tab-btn.tab-btn-active Новое
                    .tab-arrow

                a(href="#").tab-btn Популярное

            .row
                each cast in casts
                    .col-lg-2.col-md-3.col-sm-4.col-xs-4.cast-thumb
                        mixin cast_thumb(cast)

mixin casts_news_block(news_list)
    if news_list && news_list.length
        .row
            .col-lg-6.col-md-12.col-sm-12
                .row
                    if news_list && news_list.length
                        - news_item = news_list.shift();
                        .col-lg-12.col-md-8.col-sm-12.cast-news-item.is-first
                            img(src=news_item.img_url).cast-img
                        - news_item.img_url = null
                        .col-lg-12.col-md-4.col-sm-12.cast-news-item.is-first
                            mixin cast_news_item(news_item)
            .col-lg-6.col-md-12.col-sm-12
                .row
                    if news_list
                        each news_item, i in news_list
                            .col-md-4.col-lg-6.col-sm-6.cast-news-item
                                mixin cast_news_item(news_item)
                            if i > 0 && (i+1) % 2 == 0
                                .visible-lg-block.visible-sm-block.clearboth
                            if i > 0 && (i+1) % 3 == 0
                                .visible-md-block.clearboth
                        .col-md-4.col-lg-6.col-sm-6
                            .cast-news-archive
                                a(href="")
                                    .sprite.sprite-i-news-archive
                                    span Архив новостей

mixin comment_thumb(item)
    .comment
        - url = "/users/" + item.user.id
        .avatar
            - tmp_img_url = res.global.content_users + item.user.id + "/avatar"
            img(src=tmp_img_url, alt=item.user.name, data-mi-atsrc="id", data-mi-atalt="user.name")
        .comment-info
            .comment-header
                a(href=url, data-mi-name="user.name")=item.user.name
                span(data-mi-name="created", data-mi-val=item.created)=utime_text_str(item.created)
            .comment-text(data-mi-name="text")=item.text
